<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/index.js - yocto-router</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-router" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Router.html">Router</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var config        = require(&#x27;yocto-config&#x27;);
var logger        = require(&#x27;yocto-logger&#x27;);
var glob          = require(&#x27;glob&#x27;);
var _             = require(&#x27;lodash&#x27;);
var path          = require(&#x27;path&#x27;);
var joi           = require(&#x27;joi&#x27;);
var utils         = require(&#x27;yocto-utils&#x27;);
var fs            = require(&#x27;fs&#x27;);

/**
 * Yocto Router
 * Manage Your own routes defines on config files
 *
 * For more details on these dependencies read links below :
 * - yocto-logger : lab.yocto.digital:yocto-node-modules/yocto-logger.git
 * - yocto-config : lab.yocto.digital:yocto-node-modules/yocto-config.git
 * - yocto-utils : lab.yocto.digital:yocto-node-modules/yocto-utils.git
 * - Lodash : https://lodash.com/
 * - path : https://nodejs.org/api/path.html
 * - joi : https://github.com/hapijs/joi
 * - fs : https://nodejs.org/api/fs.html
 * - glob : https://www.npmjs.com/package/glob
 * 
 * @date : 09/06/2015
 * @author : ROBERT Mathieu &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 * @class Router
 */
function Router() {
  /**
   * Default logger instance
   * 
   * @property logger
   * @type Object
   */
  this.logger = logger;

  /**
   * Default config instance
   * 
   * @property config
   * @type Object
   */
  this.config = config;

  /**
   * Default base path for routes
   * 
   * @property base
   * @type String
   */  
  this.base   = process.cwd();

  /**
   * Default base path for controller assign on routes
   * 
   * @property ctrl
   * @type String
   */    
  this.ctrl = process.cwd();
  
  /**
   * Default app value must be an express app
   * 
   * @property app
   * @type String
   * @default Null
   */      
  this.app = null;
}

/**
 * Default configure method, use for main process of module
 * 
 * @method configure
 * @return {Boolean} true if all is ok false otherwise
 */
Router.prototype.configure = function() {
  // welcome message ...
  this.logger.banner(&#x27;[ Router.configure ] - Initializing Router ...&#x27;);
  
  // main process
  try {
      // config is valid ??
      if (!this.config.load()) {
        throw &#x27;Invalid config given. Please check your config files&#x27;;
      }

      // check app
      if (!_.has(this.app, &#x27;use&#x27;) || !_.isFunction(this.app.use)) {
        throw &#x27;Your app is invalid. Please ad a valid express app on your Router.app property&#x27;;        
      }

      // getting toutes
      var routes = glob.sync(&#x27;*.js&#x27;, { cwd : this.base, nosort : true, realpath : true });

      // empty routes ?
      if (_.isEmpty(routes)) {
        this.logger.warning([ &#x27;[ Router.configure ] - No routes founded on &#x27;, this.base ].join(&#x27; &#x27;));
      }
      
      // process routes item
      var nbRoutes = 0;
      
      // routes
      _.each(routes, function(item) { 
        // get controller name        
        var ctrlName = item.replace(this.base, &#x27;&#x27;);
        
        // logging message
        this.logger.info([ &#x27;[ Router.configure ] - Retreiving routes for [&#x27;, ctrlName, &#x27;]&#x27; ].join(&#x27; &#x27;));
        
        // require module
        var mods = require(item);

        // has routes ?
        if (!_.has(mods, &#x27;routes&#x27;)) {
          this.logger.warning([ &#x27;Module [&#x27;, ctrlName, &quot;] doesn&#x27;t have any routes. Remove this file or add one route configuration&quot; ].join(&#x27; &#x27;));
        } else {
            // parses routes 
            _.each(mods.routes, function(mod) {
              // validation schema
              var schema = joi.object().min(3).max(3).keys({
                method      : joi.string().required().empty().valid([ &#x27;get&#x27;, &#x27;post&#x27;, &#x27;put&#x27;, &#x27;delete&#x27;, &#x27;options&#x27;, &#x27;head&#x27;]),
                path        : joi.string().required().empty().min(3),
                controller  : joi.object().required().min(2).max(2).keys({
                  name : joi.string().required().empty().min(1),
                  fn : joi.string().required().empty().min(1)
                }).allow(&#x27;method&#x27;, &#x27;path&#x27;, &#x27;controller&#x27;)
              });

              // validate
              var result = schema.validate(mod);
              
              // has error
              if (!_.isNull(result.error)) {
                // parse details
                _.each(result.error.details, function(error) {
                  this.logger.warning([ &#x27;[ Router.configure ] - Cannot add route for&#x27;, ctrlName,&#x27;config given is invalid. Error is :&#x27;, utils.strings.inspect(error, false) ].join(&#x27; &#x27;));
                }, this);
              }
              
              // build ctrlPath
              var ctrlPath =  path.normalize([ [ this.ctrl, mod.controller.name ].join(&#x27;/&#x27;), &#x27;js&#x27; ].join(&#x27;.&#x27;));
              
              // file exits ?
              if (!fs.existsSync(ctrlPath)) {
                // it looks like no ....
                this.logger.warning([ &#x27;[ Router.configure ] - Given endpoint controller [&#x27;, mod.controller.name, &#x27;] for route [&#x27;, ctrlName, &#x27;] is invalid. Path [&#x27;, ctrlPath, &#x27;] is not found. Operation Aborted !&#x27; ].join(&#x27; &#x27;));
              } else {
                // require controller
                var controller = require(ctrlPath);

                // func exists and is a func ??
                if (!_.has(controller, mod.controller.fn) || !_.isFunction(controller[mod.controller.fn])) {
                  this.logger.warning([ &#x27;[ Router.configure ] - Cannot find Function [&#x27;, mod.controller.fn, &#x27;] for controller [&#x27;, mod.controller.name, &#x27;] on [&#x27;, ctrlPath, &#x27;]. Operation Aborted&#x27; ].join(&#x27; &#x27;));                
                } else {
                  this.logger.info([ &#x27;[ Router.configure ] - Adding route [&#x27;, mod.path, &#x27;] on a [&#x27;,  mod.method.toUpperCase(),  &#x27;] HTTP Request with a callback on [&#x27;, [ mod.controller.name, mod.controller.fn ].join(&#x27;.&#x27;), &#x27;]&#x27; ].join(&#x27; &#x27;));                  
                  // adding route to current app
                  this.app[mod.method](mod.path, controller[mod.controller.fn]);
                  // increment nb routes
                  nbRoutes++;
                }
              }
            }, this);
        } 
      }, this);
      
      // how many routes added ??
      this.logger.info([ &#x27;[ Router.configure ] -&#x27;, nbRoutes, (nbRoutes &lt; 2 ? &#x27;route&#x27; : &#x27;routes&#x27;), &#x27;was added on current app&#x27; ].join(&#x27; &#x27;));
      
  } catch (e) {
    // something is invalid
    this.logger.error([ &#x27;[ Router.configure ] - An Error occured during routes initialization. error is :&#x27;, e, &#x27;Operation aborted !&#x27; ] .join(&#x27; &#x27;));

    // statement
    return false;
  }

  // return true if all is valid 
  return true;
};

/**
 * Set function, assign given data to a property
 *
 * @method set
 * @param {String} name name of property
 * @param {Mixed} value value of property
 * @return {Object} current instance 
 */
Router.prototype.set = function(name, value) {
  // check requirements
  if (!_.isUndefined(name) &amp;&amp; _.isString(name) &amp;&amp; !_.isEmpty(name)) {    
    // is relative ?
    if ((name == &#x27;base&#x27; || name == &#x27;ctrl&#x27;) &amp;&amp; !path.isAbsolute(value)) {
      // process correct path
      value = path.normalize([ process.cwd(), value ].join(&#x27;/&#x27;));
    }
    
    // assign value
    this[name] = value;  
  } else {
    // log a warning messsage.
    this.logger.warning(&#x27;[ Router.set ] - Invalid value given. name must be a string and not empty. Operation aborted !&#x27;);
  }
  
  // returning current instance
  return this;
};

// Instanciate express with default express engine.
// Set method is available for module usage or override
module.exports = new (Router)();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
